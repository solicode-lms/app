# âœ… Activer/DÃ©sactiver Xdebug sous Windows avec PowerShell

## ğŸ¯ Objectif

Garder Xdebug **installÃ© mais inactif par dÃ©faut**, et **lâ€™activer uniquement quand nÃ©cessaire** grÃ¢ce Ã  une variable dâ€™environnement (`XDEBUG_MODE`) que ton script PowerShell bascule, puis redÃ©marrer Apache.

---

## ğŸš¨ Le problÃ¨me

Quand Xdebug reste activÃ© en permanence, il ralentit fortement PHP : chaque requÃªte Laravel ou Symfony peut prendre plusieurs secondes, mÃªme sans session de debug active. Sur Windows, cette surcharge est trÃ¨s visible et donne lâ€™impression que tout le framework est â€œlentâ€ ou â€œbloquÃ©â€, alors que câ€™est simplement Xdebug qui intercepte toutes les instructions.

---

## âš™ï¸ 1) Configuration `php.ini`

Xdebug est chargÃ© mais **dÃ©sactivÃ© par dÃ©faut**. Il sâ€™active seulement quand la variable `XDEBUG_MODE` passe Ã  `debug` :

```ini
[XDEBUG]
zend_extension="C:\php\ext\php_xdebug.dll"

; DÃ©sactivÃ© par dÃ©faut
xdebug.mode = off

; Quand activÃ©, dÃ©marre sur chaque requÃªte
xdebug.start_with_request = yes

xdebug.client_host = 127.0.0.1
xdebug.client_port = 9003
xdebug.idekey = "vscode"

; Journal pour diagnostiquer la connexion
xdebug.log = "C:\Apache24\logs\xdebug.log"
```

ğŸ’¡ Tant que `xdebug.mode = off`, Xdebug ne pÃ©nalise pas les performances.
Quand `XDEBUG_MODE=debug` est dÃ©fini au niveau Machine, Xdebug sâ€™active sans modifier `php.ini`.

---

## ğŸ–¥ï¸ 2) Script `debug.ps1`

Ce script bascule `XDEBUG_MODE` entre `debug` et `off`, puis redÃ©marre Apache :

```powershell
# Elevation automatique si non admin
if (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()
).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Start-Process powershell "-File `"$PSCommandPath`"" -Verb RunAs
    exit
}

# RÃ©cupÃ¨re la valeur actuelle
$current = [Environment]::GetEnvironmentVariable("XDEBUG_MODE", "Machine")

# Bascule debug/off
$new = if ($current -eq "debug") { "off" } else { "debug" }

# Applique la nouvelle valeur
[Environment]::SetEnvironmentVariable("XDEBUG_MODE", $new, "Machine")

Write-Host "XDEBUG_MODE changÃ© de '$current' Ã  '$new'"

# RedÃ©marre Apache
Restart-Service Apache2.4 -Force

Read-Host "Appuyez sur EntrÃ©e pour fermer"
```

---

## â–¶ï¸ 3) Utilisation

### Activer le debug

1. Lancer `debug.ps1` (il sâ€™ouvre en admin) â†’ `XDEBUG_MODE: off -> debug`.
2. DÃ©marrer lâ€™Ã©coute PHP dans VS Code (port 9003).
3. Recharger la page â†’ le breakpoint sâ€™arrÃªte dans VS Code.

### DÃ©sactiver le debug

1. Relancer `debug.ps1` â†’ `XDEBUG_MODE: debug -> off`.
2. Apache redÃ©marre, Xdebug redevient inactif â†’ performances normales.

---

## ğŸ” 4) VÃ©rifications utiles

* `phpinfo()` â†’ Xdebug `mode = debug` quand activÃ©, `off` sinon.
* `C:\Apache24\logs\xdebug.log` â†’ traces de connexion.
* Pare-feu â†’ autoriser le port **9003** en local.
* VS Code â†’ extension PHP Debug configurÃ©e avec `idekey = vscode`.

---

## âš¡ 5) Pourquoi Ã§a marche

* `xdebug.mode = off` dans `php.ini` â†’ aucun overhead hors debug.
* Le script modifie `XDEBUG_MODE` au niveau Machine â†’ Apache relit la variable au redÃ©marrage.
* `xdebug.start_with_request = yes` â†’ Xdebug sâ€™attache automatiquement Ã  chaque requÃªte quand activÃ©.

---

## ğŸ“ 6) Notes & limites

* La bascule agit uniquement sur Apache (service Windows). Pour du CLI (`php artisan`), il faut dÃ©finir `XDEBUG_MODE` dans le shell courant.
* Tu pourrais aussi utiliser `debug,develop` si tu veux plus de dÃ©tails, mais ta solution actuelle est dÃ©jÃ  efficace.

---

## âœ… RÃ©sumÃ©

* `php.ini` : Xdebug **dÃ©sactivÃ© par dÃ©faut**.
* `debug.ps1` : bascule `XDEBUG_MODE` et redÃ©marre Apache.
* RÃ©sultat : **performances normales au quotidien**, debug activable **en un clic**.

