# ✅ Activer/Désactiver Xdebug sous Windows avec PowerShell

## 🎯 Objectif

Garder Xdebug **installé mais inactif par défaut**, et **l’activer uniquement quand nécessaire** grâce à une variable d’environnement (`XDEBUG_MODE`) que ton script PowerShell bascule, puis redémarrer Apache.

---

## 🚨 Le problème

Quand Xdebug reste activé en permanence, il ralentit fortement PHP : chaque requête Laravel ou Symfony peut prendre plusieurs secondes, même sans session de debug active. Sur Windows, cette surcharge est très visible et donne l’impression que tout le framework est “lent” ou “bloqué”, alors que c’est simplement Xdebug qui intercepte toutes les instructions.

---

## ⚙️ 1) Configuration `php.ini`

Xdebug est chargé mais **désactivé par défaut**. Il s’active seulement quand la variable `XDEBUG_MODE` passe à `debug` :

```ini
[XDEBUG]
zend_extension="C:\php\ext\php_xdebug.dll"

; Désactivé par défaut
xdebug.mode = off

; Quand activé, démarre sur chaque requête
xdebug.start_with_request = yes

xdebug.client_host = 127.0.0.1
xdebug.client_port = 9003
xdebug.idekey = "vscode"

; Journal pour diagnostiquer la connexion
xdebug.log = "C:\Apache24\logs\xdebug.log"
```

💡 Tant que `xdebug.mode = off`, Xdebug ne pénalise pas les performances.
Quand `XDEBUG_MODE=debug` est défini au niveau Machine, Xdebug s’active sans modifier `php.ini`.

---

## 🖥️ 2) Script `debug.ps1`

Ce script bascule `XDEBUG_MODE` entre `debug` et `off`, puis redémarre Apache :

```powershell
# Elevation automatique si non admin
if (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()
).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Start-Process powershell "-File `"$PSCommandPath`"" -Verb RunAs
    exit
}

# Récupère la valeur actuelle
$current = [Environment]::GetEnvironmentVariable("XDEBUG_MODE", "Machine")

# Bascule debug/off
$new = if ($current -eq "debug") { "off" } else { "debug" }

# Applique la nouvelle valeur
[Environment]::SetEnvironmentVariable("XDEBUG_MODE", $new, "Machine")

Write-Host "XDEBUG_MODE changé de '$current' à '$new'"

# Redémarre Apache
Restart-Service Apache2.4 -Force

Read-Host "Appuyez sur Entrée pour fermer"
```

---

## ▶️ 3) Utilisation

### Activer le debug

1. Lancer `debug.ps1` (il s’ouvre en admin) → `XDEBUG_MODE: off -> debug`.
2. Démarrer l’écoute PHP dans VS Code (port 9003).
3. Recharger la page → le breakpoint s’arrête dans VS Code.

### Désactiver le debug

1. Relancer `debug.ps1` → `XDEBUG_MODE: debug -> off`.
2. Apache redémarre, Xdebug redevient inactif → performances normales.

---

## 🔎 4) Vérifications utiles

* `phpinfo()` → Xdebug `mode = debug` quand activé, `off` sinon.
* `C:\Apache24\logs\xdebug.log` → traces de connexion.
* Pare-feu → autoriser le port **9003** en local.
* VS Code → extension PHP Debug configurée avec `idekey = vscode`.

---

## ⚡ 5) Pourquoi ça marche

* `xdebug.mode = off` dans `php.ini` → aucun overhead hors debug.
* Le script modifie `XDEBUG_MODE` au niveau Machine → Apache relit la variable au redémarrage.
* `xdebug.start_with_request = yes` → Xdebug s’attache automatiquement à chaque requête quand activé.

---

## 📝 6) Notes & limites

* La bascule agit uniquement sur Apache (service Windows). Pour du CLI (`php artisan`), il faut définir `XDEBUG_MODE` dans le shell courant.
* Tu pourrais aussi utiliser `debug,develop` si tu veux plus de détails, mais ta solution actuelle est déjà efficace.

---

## ✅ Résumé

* `php.ini` : Xdebug **désactivé par défaut**.
* `debug.ps1` : bascule `XDEBUG_MODE` et redémarre Apache.
* Résultat : **performances normales au quotidien**, debug activable **en un clic**.

