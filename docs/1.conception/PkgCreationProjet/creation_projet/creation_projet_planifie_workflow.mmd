sequenceDiagram
    autonumber
    actor Formateur
    participant Ctrl as ProjetController
    participant PS as ProjetService
    participant PCT as ProjetCrudTrait
    participant PRT as ProjetRelationsTrait
    participant MS as MobilisationUaService
    participant TS as TacheService
    participant TAT as TacheActionsTrait

    Note over Ctrl, TS: SCENARIO : Création Projet Planifié (Avec Session)

    Formateur->>Ctrl: POST /projets (data avec session)
    Ctrl->>PS: create(data)
    
    activate PS
    
    Note right of PS: Validation & Enrichissement via Trait
    PS->>PCT: beforeCreateRules(data)
    activate PCT
    Note right of PCT: Injection auto formateur_id (Si Formateur)
    PCT-->>PS: data enrichie
    deactivate PCT

    PS->>PS: Insert Projet (Conteneur)
    
    Note right of PS: Exécution du Hook via Trait
    PS->>PCT: afterCreateRules($projet)
    activate PCT
    
    PCT->>PRT: initializeProjectStructure($projet, $session)
    activate PRT
    PRT->>PS: getTasksConfig()
    
    loop 1. Création des Tâches Standards (Analyse, Réalisation...)
        opt Si Item != Tutoriels
             PRT->>TS: create(tacheData)
        end
    end

    opt 2. Si Marqueur "Tutoriels" détecté
        Note right of PRT: Appel unique hors boucle
        PRT->>PRT: createMobilisationFromSession($projet, $session)
        
        loop Pour chaque UA de la Session
            PRT->>MS: create(data)
            activate MS
            Note right of MS: Hook afterCreateRules
            MS->>TAT: createTasksFromUa(projet_id, ua_id)
            activate TAT
            TAT->>TAT: Create "Tutoriel" Tasks
            TAT-->>MS: OK
            deactivate TAT
            MS->>MS: triggerSyncTacheEtRealisation(projet_id)
            MS-->>PRT: OK
            deactivate MS
        end
    end
    PRT-->>PCT: Structure Initialisée
    deactivate PRT

    Note right of PCT: Ajout des Livrables par défaut
    PCT->>PCT: addDefaultLivrables($projet)

    Note right of PCT: Ré-ordonnancement final
    PCT->>PCT: reorderTasksByPhase($projetId)
    
    PCT-->>PS: Fin Hook
    deactivate PCT
    
    PS-->>Ctrl: Projet Initialisé (Peuplé)
    deactivate PS
