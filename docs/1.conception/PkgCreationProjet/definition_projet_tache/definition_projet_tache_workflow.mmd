sequenceDiagram
    autonumber
    actor Formateur
    participant Ctrl as ProjetController
    participant PS as ProjetService (PkgCreationProjet)
    participant TS as TacheService (PkgCreationTache)
    participant RTS as RealisationTacheService (PkgRealisationTache)
    participant RP_S as RealisationProjetService (PkgRealisationProjets)

    Note over Ctrl, PS: Scénario 1 & 2 : Créer un Projet (Avec/Sans Session)

    Formateur->>Ctrl: POST /projets (data)
    Ctrl->>PS: create(data)
    
    activate PS
    Note right of PS: SRP: ProjetService gère uniquement<br/>la table 'projets'.
    
    alt Avec Session (contexte fourni)
        PS->>PS: Associer session/année (logique interne)
    end
    
    PS->>PS: Validation Règles Métier
    PS->>PS: DB Insert Projet
    PS-->>Ctrl: Projet Created
    deactivate PS

    Note over Ctrl, RTS: Scénario 6, 7, 8 : Gestion des Tâches (Impact sur Réalisations)

    %% AJOUT TACHE
    Formateur->>Ctrl: POST /taches (data)
    Ctrl->>TS: create(data)
    activate TS
    TS->>TS: DB Insert Tache
    
    Note right of TS: Hook afterCreateRules
    TS->>RP_S: getActiveRealisationsForProject(projet_id)
    RP_S-->>TS: Collection<RealisationProjet>
    
    loop Pour chaque RealisationProjet
        TS->>RTS: createRealisation(tache_id, realisation_projet_id)
        Note right of TS: SRP: TS délègue la création<br/>de la réalisation à RTS.
    end
    TS-->>Ctrl: Tache Created & Propagated
    deactivate TS

    %% UPDATE TACHE
    Formateur->>Ctrl: PUT /taches/{id}
    Ctrl->>TS: update(id, data)
    activate TS
    TS->>TS: DB Update Tache
    
    alt Si changement critique (ex: date limite, livrable)
        TS->>RTS: updateMetadataByTache(tache_id, data)
    end
    TS-->>Ctrl: OK
    deactivate TS

    %% DELETE TACHE
    Formateur->>Ctrl: DELETE /taches/{id}
    Ctrl->>TS: delete(id)
    activate TS
    
    Note right of TS: Hook beforeDeleteRules
    TS->>RTS: deleteByTache(tache_id)
    Note right of TS: SRP: TS demande à RTS de supprimer<br/>les réalisations liées avant de se supprimer.
    
    TS->>TS: DB Delete Tache
    TS-->>Ctrl: OK
    deactivate TS
